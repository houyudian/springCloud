<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
    <title>结算页</title>

    <link rel="stylesheet" type="text/css" href="/shop/css/webbase.css"/>
    <link rel="stylesheet" type="text/css" href="/shop/css/pages-getOrderInfo.css"/>
</head>

<body>
<!--head-->

<div class="cart py-container">
<div id="orderTip" style="color: red;"></div>
    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>
        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息<span><a data-toggle="modal" data-target=".edit" data-keyboard="false"
                                  class="newadd" onclick="toAdd()">新增收货地址</a></span></h5>
            </div>
            <div class="step-cont">
                <div class="addressInfo">
                    <ul class="addr-detail">
                        <li class="addr-item">
huahua
                        </li>

                    </ul>
                    <!--添加地址-->
                    <div tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×
                                    </button>
                                    <h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
                                </div>
                                <div class="modal-body">
                                    <form action="" class="sui-form form-horizontal">
                                        <input type="hidden" class="input-medium" id="addressId">
                                        <div class="control-group">
                                            <label class="control-label">收货人：</label>
                                            <div class="controls">
                                                <input type="text" class="input-medium" id="recipients">
                                            </div>
                                        </div>

                                        <div class="control-group">
                                            <label class="control-label">详细地址：</label>
                                            <div class="controls">
                                                <input type="text" class="input-large" id="address">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">联系电话：</label>
                                            <div class="controls">
                                                <input type="text" class="input-medium" id="phone">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">邮箱：</label>
                                            <div class="controls">
                                                <input type="text" class="input-medium" id="email">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">地址别名：</label>
                                            <div class="controls">
                                                <input type="text" class="input-medium" id="alias">
                                            </div>
                                            <div class="othername">
                                                建议填写常用地址：<a name="aliasType" class="sui-btn btn-default">家里</a>　<a
                                                    href="#" name="aliasType" class="sui-btn btn-default">父母家</a>　<a
                                                    href="#" name="aliasType" class="sui-btn btn-default">公司</a>
                                            </div>
                                        </div>

                                    </form>


                                </div>
                                <div class="modal-footer">
                                    <button type="button" data-ok="modal" class="sui-btn btn-primary btn-large"
                                            onclick="addAddress()">确定
                                    </button>
                                    <button type="button" data-ok="modal" class="sui-btn btn-primary btn-large"
                                            onclick="updateOrder()">修改
                                    </button>
                                    <button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--确认地址-->
                </div>
                <div class="hr"></div>

            </div>
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected">微信付款<span title="点击取消选择"></span></li>
                        <li>货到付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>
                <div class="step-cont">
                    <ul class="send-detail">
                        <li>

                        </li>
                        <li></li>
                        <li></li>
                    </ul>
                </div>
                <div class="hr"></div>
            </div>
            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>
            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="order-summary">
        <div class="static fr">
            <div class="list">
                <span><i class="number">1</i>件商品，总商品金额</span>
                <em class="allprice">¥0.00</em>
            </div>
            <div class="list">
                <span>返现：</span>
                <em class="money">0.00</em>
            </div>
            <div class="list">
                <span>运费：</span>
                <em class="transport">0.00</em>
            </div>
        </div>
    </div>
    <div class="clearfix trade">
        <div class="fc-price">应付金额:　<span class="price">¥0.00</span></div>
        <div class="fc-receiverInfo">寄送至:北京市海淀区三环内 中关村软件园9号楼 收货人：某某某 159****3201</div>
    </div>
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" href="javascript:void(0);" onclick="submitOrder()" >提交订单</a>
    </div>
</div>
<!-- 底部栏位 -->
<script src="/shop/jquery-3.3.1.js"></script>
<script type="text/javascript" src="/shop/js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/shop/js/plugins/sui/sui.min.js"></script>
<script src="/shop/jquery.cookie.js"></script>
<script type="text/javascript" src="/shop/js/nav-portal-top.js"></script>
<script type="text/javascript">
    $(function () {
        //查询用户的收货地址列表
        queryAddress();
       showCarts();
        createToken();
    })

var uuidToken;



    function showCarts() {
        var token =$.cookie("token");
        if (token){
            $.ajax({
                url: "http://localhost:8082/api/queryPayList",
                // dataType: "json",
                type:"get",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('x-auth', token);
                },
                success: function (result) {
                    console.log(result);
                    if (result.code == 200) {
                        var data=result.data.cartList;
                        var payHtml="";
                        var count=0;
                        for(var i=0;i< data.length;i++){
                            payHtml+='<li>';
                            payHtml+='<div class="sendGoods">';
                            payHtml+='<ul class="yui3-g">';
                            payHtml+='<li class="yui3-u-1-6">';
                            payHtml+='<span><img src="'+data[i].img+'" style="width: 50px;height: 80px"/></span>';
                            payHtml+='</li>';
                            payHtml+='<li class="yui3-u-7-12">';
                            payHtml+='<div class="desc">'+data[i].name+ '</div>';
                            payHtml+='<div class="seven">7天无理由退货</div>';
                            payHtml+='</li>';
                            payHtml+='<li class="yui3-u-1-12">';
                            payHtml+='<div class="pricee">￥'+data[i].subPrice+'</div>';
                            payHtml+='</li>';
                            payHtml+='<li class="yui3-u-1-12">';
                            payHtml+='<div class="num">X'+data[i].num+'</div>';
                            payHtml+='</li>';
                            payHtml+='<li class="yui3-u-1-12">';
                            if(data[i].stock){
                                count++;
                                payHtml+='<div class="exit">有货</div>';
                            }else{
                                payHtml+='<div class="exit">无货</div>';
                            }
                            payHtml+='</li>';
                            payHtml+='</ul>';
                            payHtml+='</div>';
                            payHtml+='</li>';
                        }
                        var totalJine=result.data.totalprice;
                        var totalNum=result.data.totalNum;
                        $(".send-detail").html(payHtml);
                        $(".number").html(count);
                        $(".allprice").html("¥"+totalJine);
                        $(".price").html("¥"+totalJine);
                        $("#jine").html("¥"+totalJine);
                    }


                }
            })
        }else{
            alert("未登录");
            location.href="/";
        }

    }

    function bindHover() {
        $(".address").hover(function () {
            $(this).addClass("address-hover");
        }, function () {
            $(this).removeClass("address-hover");
        });
    }

    function bindClick() {
        $(".addr-item .name").click(function () {
            $(this).toggleClass("selected").parent(0).siblings().find(".name").removeClass("selected");
            if (!$(this).hasClass('selected')) {
                $(".fc-receiverInfo").html('还没有选择收货地址');
            } else {
                var addressId = $(this).parent(0).attr("addressId");
                $.ajax({
                    url: "http://localhost:8020/orders/" + addressId,
                    dataType: "json",
                    type: "get",
                    success: function (result) {
                        if (result.code == 200) {
                            var data = result.data;
                            $(".fc-receiverInfo").html('寄送至:' + data.address + ' 收货人：' + data.consignee + ' ' + data.phone);
                        }
                    }
                })
            }
        });
        $(".payType li").click(function () {
            $(this).toggleClass("selected").siblings().removeClass("selected");
        });
    }

    function clearForm() {
        var formInput = $(".form-horizontal").find("input");
        $.each(formInput, function () {
            $(this).val("");
        })
    }
    function toAdd(){
        $(".modal-title").html("增加收货地址");
        clearForm();
    }

    function queryAddress() {
        var token =$.cookie("token");
        if (token){
        $.ajax({
            url: "http://localhost:8082/api/address/queryAddressList",
            type:"get",
            beforeSend: function (xhr) { //可以设置自定义标头
                // alert("获取的token值:"+token);
                xhr.setRequestHeader('x-auth', token);
            },
            success: function (result) {
               console.log(result.data)
                if (result.code == 200) {
                    var data = result.data;
                    var addressHtml = "";
                    for (var i = 0; i < data.length; i++) {
                        addressHtml += '<div addressId=' + data[i].id + '>';
                        if (i == 0) {
                            $(".fc-receiverInfo").html('寄送至:' + data[i].name + ' 收货人：' + data[i].area + ' ' + data[i].phone);
                            addressHtml += '<div class="con name selected" addressId="'+data[i].id+'"><a href="javascript:;" >' + data[i].area + '<span title="点击取消选择">&nbsp;</a></div>';
                        } else {
                            addressHtml += '<div class="con name" addressId="'+data[i].id+'"><a href="javascript:;" >' + data[i].area + '<span title="点击取消选择">&nbsp;</a></div>';
                        }
                        var tel = data[i].phone;
                        tel = "" + tel;
                        var ary = tel.split("");
                        ary.splice(3,4,"****");
                        var tel1=ary.join("");
                        console.log(tel1);
                        addressHtml += '<div class="con address">' + data[i].area + '  ' + data[i].address + ' <span>' + tel1 + '</span>';
                        if (i == 0) {
                            addressHtml += '<span class="base">默认地址</span>';
                        }
                        $(".price").html(data[i].total);
                        addressHtml += '<span class="edittext"><a data-toggle="modal" addressId="' + data[i].id + '" onclick="toUpdate(this)" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:void(0);" onclick="deleteOrder('+data[i].id+')">删除</a></span>';
                        addressHtml += '</div>';
                        addressHtml += '<div class="clearfix"></div>';
                        addressHtml += '</div>';

                    }

                    $(".addr-item").html(addressHtml);
                    bindHover();
                    bindClick();
                }
            }
        })
        }else{
            alert("未登录");
            location.href="/";
        }
    }

    function addAddress() {
        var area = $("#recipients").val();
        var address = $("#address").val();
        var phone = $("#phone").val();
        var email = $("#email").val();
        var alias = $("#alias").val();
        var id=$("#addressId").val();
        $.ajax({
            url: "http://localhost:8082/api/address",
            dataType: "json",
            type: "post",
            data: {
                "id": id,
                "area": area,
                "name": address,
                "phone": phone,
                "mail": email,
                "alias": alias
            },
            success: function (result) {
                if (result.code == 200) {
                    alert("地址添加成功");
                    queryAddress();
                }
            }
        })
    }

    function toUpdate(obj) {
        clearForm();
        var addressId = $(obj).attr("addressId");
        $(".modal-title").html("修改收货地址");
        $.ajax({
            url: "http://localhost:8082/api/" + addressId,
            dataType: "json",
            success: function (result) {
                if (result.code == 200) {
                    var data = result.data;
                    $("#recipients").val(data.area);
                    $("#address").val(data.name);
                    $("#phone").val(data.phone);
                    $("#email").val(data.mail);
                    $("#alias").val(data.alias);
                    $("#addressId").val(data.id);
                }
            }
        })

    }

    function updateOrder(){
        var area = $("#recipients").val();
        var address = $("#address").val();
        var phone = $("#phone").val();
        var email = $("#email").val();
        var alias = $("#alias").val();
        var id=$("#addressId").val();
        $.ajax({
            url: "http://localhost:8020/orders/updateOrder",
            dataType: "json",
            type: "post",
            data: {
                "id": id,
                "area": area,
                "name": address,
                "phone": phone,
                "mail": email,
                "alias": alias
            },
            success: function (result) {
                if (result.code == 200) {
                    alert("地址添加成功");
                    queryAddress();
                }
            }
        })

    }

    function deleteOrder(orderId){
        alert(orderId);
        $.ajax({
            url:"http://localhost:8020/orders/deleteOrder",
            type:"delete",
            async:false,
            data:{
                "orderId":orderId
            },
            dataType:"json",
            success:function (result) {
                if (result.code==200){
                    history.go();
                    alert("删除成功");
                }

            }

        })

}

    function submitOrder1() {
        var addressId=$(".addr-item .selected").attr("addressId");
        $.ajax({
            url:"http://localhost:8020/shopOrder",
            type:"put",
            data:{"addressId":addressId},
            dataType:"json",
            success:function (result) {
               // alert(JSON.stringify(result))

                if (result.code==200){
                    var resultData=result.data;
                    var understockList=resultData.understockList;
                    var alertMessage="你购买的商品：";
                    for (var i=0;i< understockList.length;i++){

                        alertMessage+=understockList[i].productName+":";
                    }
                    alertMessage="库存不足";
                    if (understockList.length>0){
                        alert(alertMessage);
                    }
                    sessionStorage.setItem("outTradeNo",result.data.outTradeNo);
                    sessionStorage.setItem("orderId",result.data.orderId);

                    window.location.href="/carts/pay.html";
                }else{
                    alert(result.message);
                }
            }

        })
    }
    function createToken() {
        $.ajax({
            url:"",
            success:function (result) {
                var uuidToken=result.data;
            }
        })
    }

    function submitOrder() {
        var token =$.cookie("token");
        var addressId=$(".addr-item .selected").attr("addressId");
        console.log(addressId+"==============地址id")
        if (token){
            var param={};

            param.addressId=addressId;
            param.payType=1;
            $.ajax({
                url: "http://localhost:8082/api/orders/generateOrder",
                type:"post",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('x-auth', token);
                    xhr.setRequestHeader('token', uuidToken);
                },
                data:param,
                success: function (result) {
                    console.log(result)
                    if (result.code == 200) {
                        getResult();
                    }
                }
            })
        }else{
            alert("未登录");
            location.href="/";
        }
    }
    function getResult() {
        var token =$.cookie("token");
        if (token){
            $.ajax({
                url: "http://localhost:8082/api/orders/getResult",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('x-auth', token);
                },
                success: function (result) {
                    console.log(result)
                    if (result.code == 200) {
                        location.href="pay.html";
                    }else if (result.code==4001){
                        $("#orderTip").html("<h1>库存不足</h1>")
                    }else if (result.code==4002){
                        $("#orderTip").html("<h1>系统异常，订单创建失败</h1>")
                    }else if (result.code==4003){
                        $("#orderTip").html("<h1>正在加载！！稍等</h1>")
                        setTimeout(function () {
                            getResult()
                        },300)
                    }
                }

            })
        }else{
            alert("未登录");
            location.href="/";
        }
    }
</script>
</body>

</html>
